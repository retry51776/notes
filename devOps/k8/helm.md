# Helm

> Helm is the package manager for Kubernetes.
>
> **Helm < 2.0** used a client‑server architecture (Tiller). Since version 3.0 there is no Tiller.
>
> The biggest features of Helm are uninstall and rollback.
>
> [(Go template language)](https://pkg.go.dev/text/template)
>
> [(YAML guide)](https://helm.sh/docs/chart_template_guide/yaml_techniques/)

## Helm Lifecycle

```yaml
metadata:
  annotations:
    # Event examples: pre-install, pre-upgrade, pre-rollback, test …
    "helm.sh/hook": post-install
    # Lower numbers execute first
    "helm.sh/hook-weight": "-5"
    "helm.sh/hook-delete-policy": "hook-succeeded,before-hook-creation,hook-failed"
```

## Helm Commands

```bash
# Install tools
brew install helm
brew install kustomize
brew install chart-testing

# Helm's unit‑test plugin
helm plugin install https://github.com/lrills/helm-unittest

# By default Helm does not have a public repository (unlike npm or pip)
helm repo add stable https://charts.helm.sh/stable
helm repo add traefik https://helm.traefik.io/traefik

# If a chart is broken, fix it by updating the repository index
helm repo update

# Inspect a chart before installing
helm show chart traefik/traefik
helm dependency list <chart-name>

# Install a chart with custom values (two ways: a values file or --set)
# 1. Create a chart folder
# 2. Pull the chart and inspect its code
# 3. Create xxx-config.yml
# 4. Install:
helm install --values=xxx-config.yaml <release-name> <chart-repo>/<chart-name>

# Pull a chart as a tarball
helm pull bitnami/redis --untar
helm pull traefik/traefik

# Install with custom values and namespace
helm install --values=xxx.yaml <release-name> <chart-name> --namespace kube-system

# Example: enable the Traefik dashboard
helm install traefik traefik/traefik \
  --set dashboard.enabled=true,serviceType=LoadBalancer,rbac.enabled=true,dashboard.domain=traefik.local

helm uninstall <release-name>

# Repository operations
helm template Release1 helm-charts
helm search hub <keyword>
helm search repo <keyword>
helm search <keyword>

# Chart operations
# Render a chart locally (debug mode)
helm template --debug <chart_name>

# Dry‑run an install to see the rendered manifests
helm install --dry-run measly-whippet ./mychart
helm install --dry-run --disable-openapi-validation measly-whippet ./mychart

# Test a release
helm test <RELEASE_NAME>

# Create a new chart scaffold
helm create <chart-name>
helm package <chart-directory>
```

## Helm Structure

> Example: https://github.com/traefik/traefik-helm-chart/blob/master/traefik/

```
helm-charts/
  charts/                # Sub‑charts
  templates/            # Kubernetes objects generated by the chart
    _helpers.tpl        # Define common template snippets
    NOTES.txt           # Installation notes displayed after a release
    tests/              # Helm test hooks
  values.yaml           # Default configuration values
  Chart.yaml            # Chart metadata
```

### Example Template Snippet

```gotemplate
{{- define "xxx.label" }}
{{- end }}

# templates/xxx_deployment.yaml
{{- template "xxx.label" . }}
```

## Helm Workflow Control & Reference

> This reminds me of PHP programming.

```gotemplate
{{- /* Remove line space */ -}}
test:
  {{- .Release.Name }}

{{- toYaml .Values.xxx | nindent 8 }}
{{ include "helm-charts.labels" . | nindent 4 }}
{{ .Values.service.name | default "10m" | quote }}

toppings: |-
{{- range $.Values.pizzaToppings }}
  - {{ . | title | quote }}
{{- end }}

{{- with .Values.xx.xxx.xxxx }}
grand_child: yy
root_xx: {{ $.Values.xx }}
{{- end }}

{{- range $index, $service := (lookup "v1" "Service" "mynamespace" "").items }}
  {{/* Do something with each service */}}
{{- end }}

# Operators (eq, ne, lt, gt, and, or, …)

{{- $files := .Files }}
{{- range tuple "config1.toml" "config2.toml" "config3.toml" }}
{{ . }}: |-
  {{ $files.Get . }}
{{- end }}
```

### Using `tpl` to Render a Template String

```gotemplate
# The `tpl` function renders the string as a template.
{{ tpl .Values.str_template . }}

# Trim whitespace from a value
{{- .Values.str_w_space -}}
```
