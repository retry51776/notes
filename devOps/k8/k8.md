# Kubernetes Overview

> Here is an overview of Kubernetes architecture.

> Originated from Google Borg in 2014 and now part of the Cloud Native Computing Foundation (CNCF).

> Infrastructure as code.

> Packages: <https://artifacthub.io/>

Kubernetes requires an **external load balancer**, or you can use MetalLB.

## Important Ordering

- Define a Service before a Deployment. When a Pod is created, Kubernetes injects the Service’s environment variables.
- Create Secrets before RoleBindings.

## Cloud‑Provider Benefits

- IAM – cloud providers offer built‑in IAM with nice interfaces; self‑hosted clusters must manage authentication via certificates or service‑account tokens.
- External LoadBalancer – clouds provide managed load balancers that assign public IPs (alternatively, use MetalLB).
- Logging – most clouds have integrated logging solutions; you can also set up ELK/Kibana yourself.
- Rich UI – dashboards are often better than extensions.
- Advanced Ingress – cloud‑provided ingress controllers are usually more feature‑rich.

## Analogy

> <https://docs.google.com/presentation/d/1nOuYvXbQCjM_c869Mfyv59xfz-2f_QE4K1d0dUQQc4k/edit?usp=sharing>

> <https://docs.google.com/spreadsheets/d/1AFTh5TOIDBw-ap7UD05vcFFjxfIGeVUEv0EROzYv8Mw/edit?usp=sharing>

- **External Load Balancer** (Public Street Entry)
- **Namespace** – a section of the mall; groups Kubernetes resources and allows Role‑based permissions.
- **Network Policy** – an elevator; controls inbound/outbound traffic for a namespace or set of Pods.
- **Cluster** – the shopping mall; without a parking lot, customers must walk into stores.
- **Node** – a building within the mall; a cluster can have one or many nodes.
- **Pod** – an area inside a building; can host multiple containers (store/app deployment, hallway/load balancer, service, job). By default it is isolated; you need a Service to expose it.

  - **Container** – a worker inside the store; all containers in a Pod share the same network namespace and resources.
  - **Probe** – construction signs indicating whether the area is ready or under maintenance.
  - **DaemonSet** – building requirements (e.g., emergency exit, information desk, bathrooms). Similar to ensuring every node runs logging, metrics, or storage agents.
  - **Deployment** – chain stores; multiple identical Pods that can scale based on traffic.
  - **Naked Pod** – a mom‑and‑pop store; independent and not managed by a controller.

- **API Server** – the mall manager
  - **etcd** – the manager’s notebook.
  - **Controller & Scheduler** – assistants that maintain services, authentication, and schedule Pods onto Nodes.
  - **CoreDNS** – guides public traffic to the cluster; runs on master nodes.
  - **kubelet** – building manager; follows the API Server’s directions. You can also interact directly with it.
  - **kube‑proxy** – information desk; handles intra‑cluster traffic.

- **Service** – a map of the mall; three types:
  - LoadBalancer (entry point)
  - NodePort
  - ClusterIP

- **Endpoint** – store numbers; each Service maps to one or more Pod IPs and ports.

## Workflow Overview

1. Authentication [cert, token]
2. Authorization [RBAC: verb, resource, API group, namespace]
3. Mutating webhook (optional)
4. AdmissionReview
5. Validating webhook (optional)
6. Lock etcd (only on edit)
7. Edit etcd (only on edit)
8. API server watch triggers kube‑scheduler
9. Scheduler → controller manager → kubelet (assigns Pods to Nodes with sufficient resources)
10. Kubelet sends Container Runtime Interface (CRI) request
11. CRI calls Container Network Interface (CNI), which assigns an IP to the Pod
12. CNI returns to CRI, which starts the container runtime
13. Probes are executed
14. InitContainers start
15. Main containers start
16. Endpoints are assigned
17. Pods discover and attach to Services

## Core Objects / Resources / Manifests

- **Pods** – smallest unit.
- **ReplicaSet**, **Deployment**, **DaemonSet**, **Job**, **CronJob**
- **Service**, **Ingress**, **ConfigMap**, **Secret**, **PersistentVolume**, **PersistentVolumeClaim**
- **Role**, **ClusterRole**, **RoleBinding**, **ClusterRoleBinding**
- **Namespace**, **Node**, **Event**, **PodDisruptionBudget**, **ResourceQuota**

## Ingress

> An ingress is a layer‑7 (HTTP/HTTPS) controller that routes external traffic to Services.

### Types

- Single Service
- Simple Fanout
- Name‑based virtual hosting

## Node Components

![Kubernetes components diagram](../../static/kubernetes_architecture.png)

- **kubelet**
  1. Schedules Pods onto the node.
  2. Pulls container images.
  3. Starts containers.

- **kube-proxy**
  1. Manages iptables rules based on Service definitions.
  2. Provides internal DNS and load balancing.

- **Container Runtime**
  - CRI‑O
  - containerd (with `cri-dockerd`)
  - Docker (via `dockershim`, now deprecated)
  - Mirantis Container Runtime

## Networking

> The default CNI is Calico; it may not be installed automatically.

- Each Pod receives a unique IP address.
- Containers within the same Pod communicate via `localhost`.

### VM Drivers

> containerd and cri‑o are common runtimes.

- podman
- virtualbox
